<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <title>Live Location</title>
  <style>
    body { font-family: Arial; text-align: center; }
    #map { width: 100%; height: 400px; margin-top: 15px; }
    #info { margin-top: 10px; }
  </style>
</head>
<body>

<h2>ğŸ“ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</h2>
<button onclick="start()">Ø§Ø¨Ø¯Ø£ Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù…ÙˆÙ‚Ø¹</button>

<div id="map"></div>
<div id="info"></div>

<script>
let map, marker, watchId;
const sessionId = Math.random().toString(36).substring(2);

// ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„Ø£ÙˆÙ„ Ù…Ø±Ø©
function initMap(lat, lng) {
  map = new google.maps.Map(document.getElementById("map"), {
    center: { lat, lng },
    zoom: 17,
    mapTypeId: "roadmap"
  });

  marker = new google.maps.Marker({
    position: { lat, lng },
    map: map,
    title: "Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ"
  });
}

// ØªØ´ØºÙŠÙ„ ØªØªØ¨Ø¹ Ø§Ù„Ù€ GPS
function start() {
  if (!navigator.geolocation) {
    alert("Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… GPS");
    return;
  }

  watchId = navigator.geolocation.watchPosition(
    pos => {
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;
      const accuracy = pos.coords.accuracy;

      document.getElementById("info").innerHTML =
        `ğŸ“ Ø§Ù„Ø¯Ù‚Ø©: ${Math.round(accuracy)} Ù…ØªØ±`;

      if (accuracy > 100) {
        document.getElementById("info").innerHTML +=
          "<br>âš ï¸ ÙØ¹Ù‘Ù„ Precise Location Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¯Ù‚Ø© Ø£ÙØ¶Ù„";
      }

      if (!map) {
        initMap(lat, lng);
      } else {
        const newPos = { lat, lng };
        marker.setPosition(newPos);
        map.setCenter(newPos);
      }

      fetch("/api/location", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "x-session-id": sessionId
        },
        body: JSON.stringify({ lat, lng, accuracy })
      });
    },
    err => {
      alert("Ù„Ø§Ø²Ù… ØªØ³Ù…Ø­ Ø¨Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ø¯Ù‚Ø© (Precise Location)");
    },
    {
      enableHighAccuracy: true,
      timeout: 15000,
      maximumAge: 0
    }
  );
}
</script>

<script async
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBGVJpgTsnmYt5YP18wvzaoxdmVoaIhEvs">
</script>

</body>
</html>
